# Настройка правил Firebase Storage

## Проблемы и решения

### Ошибка 403 (Forbidden)
`Firebase Storage: User does not have permission to access 'profile_pictures/...' (storage/unauthorized)`

**Причина**: Правила Firebase Storage не настроены или не разрешают загрузку.

### Ошибка 504 (Gateway Timeout)
**Причина**: Таймаут при загрузке. Возможные причины:
- Слишком большой файл
- Медленное интернет-соединение
- Проблемы на стороне Firebase

### Ошибка 404 (Not Found)
**Причина**: Файл не найден. Возможно, это старый файл с неправильным именем.

### Важно: Проверьте проект Firebase
В ошибке может быть указан другой проект Firebase (например, `mainproject-7f683`), но в `environment.ts` указан `akzhols-market`. Убедитесь, что:
1. Используется правильный проект Firebase
2. Правила применены к правильному проекту
3. Конфигурация в `environment.ts` соответствует вашему проекту

## Решение

Есть два способа настроить правила Firebase Storage:

### Способ 1: Через Firebase Console (Рекомендуется)

1. Откройте [Firebase Console](https://console.firebase.google.com/)
2. **ВАЖНО**: Выберите правильный проект:
   - Если в ошибке указан `mainproject-7f683`, выберите этот проект
   - Если используете `akzhols-market`, выберите его
   - Проверьте `environment.ts` для подтверждения проекта
3. Перейдите в раздел **Storage** (в левом меню)
4. Откройте вкладку **Rules** (Правила)
5. Замените содержимое на следующие правила:

```javascript
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Правила для аватаров профилей
    match /profile_pictures/{userId}/{fileName} {
      // Разрешаем чтение всем (чтобы аватары были публичными)
      allow read: if true;
      
      // Разрешаем загрузку только авторизованным пользователям в свою папку
      allow write: if request.auth != null && request.auth.uid == userId
                   && request.resource.size < 5 * 1024 * 1024  // Максимум 5MB
                   && request.resource.contentType.matches('image/.*');
      
      // Разрешаем удаление только владельцу файла
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // Запрещаем доступ ко всем остальным файлам по умолчанию
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
```

6. Нажмите **Publish** (Опубликовать)

### Способ 2: Через Firebase CLI

Если у вас установлен Firebase CLI:

1. Установите Firebase CLI (если еще не установлен):
   ```bash
   npm install -g firebase-tools
   ```

2. Войдите в Firebase:
   ```bash
   firebase login
   ```

3. Инициализируйте проект (если еще не инициализирован):
   ```bash
   firebase init storage
   ```
   Выберите ваш проект и используйте файл `storage.rules` из корня проекта.

4. Разверните правила:
   ```bash
   firebase deploy --only storage
   ```

## Что делают эти правила?

- ✅ **Чтение**: Все могут читать аватары (публичный доступ)
- ✅ **Запись**: Только авторизованные пользователи могут загружать файлы в свою папку `profile_pictures/{userId}/`
- ✅ **Валидация**: Файлы должны быть изображениями и не превышать 5MB
- ✅ **Удаление**: Только владелец может удалять свои файлы
- ✅ **Безопасность**: Все остальные пути заблокированы

## Проверка

После применения правил:
1. **Подождите 10-30 секунд** - правила могут применяться с задержкой
2. Обновите страницу приложения (Ctrl+F5 или Cmd+Shift+R для полной перезагрузки)
3. Убедитесь, что вы авторизованы в приложении
4. Попробуйте загрузить аватар снова
5. Ошибка должна исчезнуть

## Устранение проблем

### Если ошибка 403 все еще появляется:
1. Проверьте, что вы вошли в правильный проект Firebase Console
2. Убедитесь, что правила сохранены и опубликованы (кнопка "Publish")
3. Проверьте, что пользователь авторизован в приложении
4. Проверьте, что `uid` в пути соответствует `request.auth.uid` в правилах
5. Очистите кэш браузера и попробуйте снова

### Если ошибка 504 (Timeout):
1. Уменьшите размер файла (код автоматически сжимает до 800px)
2. Проверьте скорость интернета
3. Попробуйте загрузить файл меньшего размера
4. Подождите и попробуйте снова через несколько минут

### Если ошибка 404:
1. Это может быть старый файл с неправильным именем
2. Попробуйте загрузить новый файл
3. Код теперь автоматически генерирует безопасные имена файлов

## Важно!

- Правила могут применяться с задержкой до 30 секунд
- Убедитесь, что используете правильный проект Firebase
- Проверьте, что пользователь авторизован перед загрузкой

